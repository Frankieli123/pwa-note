# 大文件上传直接到MinIO方案

## 问题描述
用户反馈大文件（如200MB）上传失败，小文件正常。经分析发现是Next.js API路由默认1MB限制导致。

## 根本原因分析

### 1. Next.js API路由限制
- Next.js默认对API路由请求体大小限制为1MB
- `next.config.js`中未配置`api.bodyParser.sizeLimit`
- 200MB文件在到达后端验证前就被拦截

### 2. 文件大小验证被禁用
- `lib/minio-utils.ts`中`validateFileSize`函数返回`{ valid: true }`
- 完全跳过了大小验证逻辑

### 3. 内存处理问题
- `uploadFileToMinio`函数使用`await file.arrayBuffer()`
- 整个文件加载到内存，200MB文件造成内存压力

### 4. 缺少超时配置
- 没有为大文件上传设置适当的超时时间

## 解决方案：直接上传到MinIO

### 方案优势
- **绕过服务器限制**：文件直接上传到MinIO，不经过Next.js服务器
- **性能最佳**：减少服务器负载，提高上传速度
- **支持超大文件**：理论上支持任意大小文件
- **更好的用户体验**：真实的上传进度，断点续传可能性

### 技术架构
```
前端 → 获取预签名URL → 直接上传到MinIO → 通知后端完成 → 保存元数据
```

## 实施计划

### 任务1：创建MinIO预签名URL生成API
**文件：** `app/api/files/presigned-url/route.ts`
**功能：**
- 生成临时上传凭证和预签名URL
- 文件类型和大小验证
- 设置适当的过期时间（1小时）
- 返回上传所需的所有参数

### 任务2：修改前端上传逻辑
**文件：** `components/sync-provider.tsx` (useSync hook)
**功能：**
- 获取预签名URL
- 直接上传到MinIO
- 实时上传进度监控
- 错误处理和重试机制

### 任务3：创建上传完成通知API
**文件：** `app/api/files/upload-complete/route.ts`
**功能：**
- 验证文件确实已上传到MinIO
- 保存文件元数据到数据库
- 返回完整的文件信息

### 任务4：恢复文件大小验证逻辑
**文件：** `lib/minio-utils.ts`
**功能：**
- 设置合理的大小限制（500MB）
- 在预签名URL生成时进行验证
- 保持类型验证逻辑

### 任务5：优化用户体验
**文件：** `components/file-uploader.tsx`
**功能：**
- 更新上传进度显示
- 改进错误提示信息
- 大文件上传状态指示

### 任务6：测试验证
**测试范围：**
- 小文件上传兼容性
- 大文件上传（200MB+）
- 错误处理和边界情况
- 网络中断恢复

## 预期效果

### ✅ 解决的问题
- 200MB大文件可以正常上传
- 上传速度显著提升
- 服务器负载减少
- 更好的错误处理

### ✅ 保持的功能
- 文件类型验证
- 用户权限控制
- 数据库元数据管理
- 现有UI组件兼容

## 风险评估

### 低风险
- **安全性**：使用临时凭证，过期时间短
- **兼容性**：保持现有API接口不变
- **回滚**：可以快速回退到原方案

### 注意事项
- MinIO凭证安全管理
- 预签名URL过期处理
- 上传失败的清理机制

## 成功标准
1. 200MB文件能够成功上传
2. 小文件上传保持正常
3. 上传进度准确显示
4. 错误处理完善
5. 性能提升明显

## 实施完成状态

### ✅ 已完成的任务

1. **[x] 创建MinIO预签名URL生成API**
   - 文件：`app/api/files/presigned-url/route.ts`
   - 功能：生成临时上传凭证和预签名URL
   - 验证：文件类型和大小验证（500MB限制）
   - 安全：1小时过期时间

2. **[x] 创建上传完成通知API**
   - 文件：`app/api/files/upload-complete/route.ts`
   - 功能：验证文件上传并保存元数据到数据库
   - 验证：确认文件存在于MinIO
   - 数据库：保存完整文件信息

3. **[x] 恢复文件大小验证逻辑**
   - 文件：`lib/minio-utils.ts`
   - 限制：500MB最大文件大小
   - 验证：在预签名URL生成时进行验证

4. **[x] 修改前端上传逻辑**
   - 文件：`components/sync-provider.tsx`
   - 流程：获取预签名URL → 直接上传到MinIO → 通知后端
   - 进度：实时上传进度监控
   - 缩略图：自动生成和上传图片缩略图

5. **[x] 优化用户体验**
   - 文件：`components/file-uploader.tsx`
   - 进度：详细的上传阶段显示
   - 错误：改进的错误提示信息
   - 提示：大文件上传耐心等待提示

6. **[x] 测试验证**
   - 文件：`scripts/test-upload-apis.js`、`app/test-upload/page.tsx`
   - API测试：预签名URL和上传完成API
   - 前端测试：完整的上传流程测试
   - 错误测试：边界情况和错误处理

### 🔧 技术实现细节

**新的上传流程：**
```
1. 前端验证文件 →
2. 获取预签名URL →
3. 直接上传到MinIO →
4. 生成缩略图（图片） →
5. 通知后端保存元数据 →
6. 更新UI
```

**关键改进：**
- 绕过Next.js 1MB限制
- 减少服务器内存使用
- 提高上传速度
- 支持真实的上传进度
- 更好的错误处理

### 📊 测试结果

**API测试：**
- ✅ 预签名URL生成正常
- ✅ 文件大小验证有效（500MB限制）
- ✅ 参数验证完善
- ✅ 错误处理正确

**前端测试：**
- ✅ 上传进度显示准确
- ✅ 错误提示信息清晰
- ✅ 大文件上传提示友好
- ✅ 缩略图生成正常

### 🚀 部署说明

1. **环境变量确认：**
   - `MINIO_ENDPOINT`
   - `MINIO_ACCESS_KEY`
   - `MINIO_SECRET_KEY`
   - `MINIO_BUCKET_NAME`

2. **测试步骤：**
   - 访问 `/test-upload` 页面进行测试
   - 运行 `node scripts/test-upload-apis.js` 测试API
   - 测试不同大小的文件上传

3. **监控要点：**
   - MinIO存储使用情况
   - 上传成功率
   - 错误日志
   - 用户反馈
