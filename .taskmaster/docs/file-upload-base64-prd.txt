# PWA Note 文件上传功能重构 - Base64存储方案

## 项目概述
将 PWA Note 应用的文件上传功能从服务器存储重构为 Base64 数据库存储，实现完全本地化的文件管理和更好的离线体验。

## 问题陈述
当前 PWA Note 应用的文件上传功能存在以下问题：
1. 依赖外部文件服务器 (124.243.146.198:3001)，增加了系统复杂性
2. 网络依赖导致离线时无法上传文件
3. 服务器维护成本和可靠性问题
4. 跨设备同步需要额外的服务器配置

## 目标和目的
1. 移除所有服务器上传相关代码和依赖
2. 实现文件和图片的 Base64 数据库存储
3. 提供完全离线的文件上传和管理体验
4. 简化系统架构，减少外部依赖
5. 保持现有的用户体验和功能完整性

## 目标用户
- PWA Note 应用的所有用户
- 需要离线文件上传和管理的用户
- 希望减少网络依赖的用户

## 功能和需求

### 核心功能
1. **Base64 文件上传**
   - 图片转换为 Base64 存储到数据库
   - 文档转换为 Base64 存储到数据库
   - 支持拖拽和点击上传

2. **文件类型支持**
   - 图片：JPEG, PNG, GIF, WebP (最大 5MB)
   - 文档：PDF, DOC, DOCX, TXT, XLS, XLSX, CSV (最大 20MB)

3. **客户端处理**
   - 使用 FileReader API 转换文件为 Base64
   - 客户端文件类型验证
   - 客户端文件大小检查
   - 图片缩略图生成（可选）

4. **文件管理**
   - 文件列表显示（从数据库读取 Base64）
   - 文件删除功能
   - 文件下载功能（Base64 转换为下载链接）
   - 图片预览（直接显示 Base64）

5. **用户体验**
   - 上传进度显示
   - 错误处理和提示
   - 响应式设计
   - 离线支持

## 技术需求

### 前端修改
1. **移除服务器上传代码**
   - 删除所有外部服务器 API 调用
   - 移除 FormData 上传逻辑
   - 清理服务器相关配置

2. **实现 Base64 转换**
   - 使用 FileReader API 读取文件
   - 转换为 Base64 格式
   - 处理不同文件类型的 MIME 类型前缀

3. **数据库存储优化**
   - 修改数据库 schema 支持 Base64 存储
   - 优化大数据存储性能
   - 实现数据压缩（可选）

### 后端修改
1. **数据库 Schema 更新**
   - 修改 files 表结构
   - 增加 Base64 数据字段
   - 保持向后兼容性

2. **API 接口调整**
   - 修改文件创建接口
   - 更新文件查询逻辑
   - 移除服务器上传相关接口

### 性能考虑
1. **文件大小限制**
   - 图片最大 5MB
   - 文档最大 20MB
   - Base64 编码后大小约增加 33%

2. **数据库优化**
   - 使用 TEXT 或 LONGTEXT 字段存储 Base64
   - 考虑分页加载大文件列表
   - 实现缓存机制

## 实施计划

### 阶段1：代码清理
- 移除所有服务器上传相关代码
- 清理外部 API 调用
- 移除不需要的依赖

### 阶段2：Base64 实现
- 实现 FileReader API 文件读取
- 添加 Base64 转换逻辑
- 更新文件上传流程

### 阶段3：数据库更新
- 修改数据库 schema
- 更新 API 接口
- 实现数据迁移

### 阶段4：测试和优化
- 功能测试
- 性能测试
- 用户体验优化

## 验收标准
1. 所有服务器上传代码已移除
2. 文件和图片可以成功转换为 Base64 并存储
3. 文件列表正常显示
4. 文件下载功能正常
5. 图片预览功能正常
6. 离线上传功能正常
7. 性能满足要求（上传响应时间 < 3秒）
8. 无功能回归问题

## 风险和缓解措施
1. **数据库大小增长**
   - 缓解：实施文件大小限制
   - 缓解：定期清理过期文件

2. **性能影响**
   - 缓解：实施分页加载
   - 缓解：优化数据库查询

3. **浏览器兼容性**
   - 缓解：使用 FileReader API polyfill
   - 缓解：渐进式增强

## 成功指标
- 移除服务器依赖：100%
- 文件上传成功率：>99%
- 上传响应时间：<3秒
- 离线功能可用性：100%
- 用户体验评分：保持或提升
